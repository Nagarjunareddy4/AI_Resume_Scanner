<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Scanner</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .upload-zone {
      border: 2px dashed #cbd5e1;
      transition: all 0.3s ease;
    }
    
    .upload-zone:hover {
      border-color: #3b82f6;
      background-color: rgba(59, 130, 246, 0.1);
    }
    
    .upload-zone.drag-over {
      border-color: #3b82f6;
      background-color: rgba(59, 130, 246, 0.2);
    }
    
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 999;
    }
    
    .results-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 900px;
      width: 90%;
      max-height: 85%;
      overflow-y: auto;
      z-index: 1000;
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -45%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }
    
    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9998;
      animation: fadeIn 0.3s ease-out;
    }
    
    .tour-spotlight {
      position: absolute;
      border: 3px solid #3b82f6;
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
      z-index: 9999;
      transition: all 0.3s ease-out;
    }
    
    .tour-tooltip {
      position: fixed;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      z-index: 10000;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .delete-btn {
      transition: transform 0.2s ease;
    }
    
    .delete-btn:hover {
      transform: scale(1.1);
    }
    
    .suggestion-card {
      border-left: 4px solid #3b82f6;
    }
    
    .mode-toggle {
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .mode-toggle:hover {
      transform: scale(1.1);
    }
    
    .error-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ef4444;
      color: white;
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1001;
      animation: slideUpBanner 0.3s ease-out;
    }
    
    @keyframes slideUpBanner {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .scanning-progress {
      margin-top: 12px;
      padding: 16px;
      border-radius: 8px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full overflow-auto"><!-- Header -->
   <header class="py-8 px-6 text-center relative">
    <div class="absolute top-6 right-6 flex gap-4 items-center"><button id="modeToggle" class="mode-toggle p-3 rounded-lg" title="Toggle Dark/Light Mode">
      <svg id="modeIcon" class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
      </svg></button> <button id="tourBtn" class="p-3 rounded-lg font-medium" title="Start Tour">
      <svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg></button>
    </div>
    <h1 id="appTitle" class="text-5xl font-bold mb-2">Resume Scanner</h1>
    <p id="subtitle" class="text-xl">AI-Powered Resume Matching</p>
    <div class="mt-4"><label class="inline-flex items-center cursor-pointer"> <input type="checkbox" id="candidateMode" class="sr-only peer">
      <div class="relative w-14 h-7 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div><span id="candidateModeLabel" class="ms-3 text-sm font-medium">Candidate Mode</span> </label>
    </div>
   </header><!-- Main Content -->
   <main class="max-w-7xl mx-auto px-6 pb-8"><!-- Upload Section -->
    <div class="grid md:grid-cols-2 gap-6 mb-8"><!-- Job Description Upload -->
     <div class="p-6 rounded-xl shadow-lg">
      <h2 id="jdUploadLabel" class="text-2xl font-semibold mb-4">Upload Job Description</h2>
      <div id="jdDropZone" class="upload-zone rounded-lg p-8 text-center cursor-pointer">
       <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
       </svg>
       <p class="text-lg mb-2">Drop JD file here or click to browse</p>
       <p class="text-sm">Supports .txt, .pdf, .docx, .jpg, .png, .jpeg</p><input type="file" id="jdInput" class="hidden" accept=".txt,.pdf,.docx,.jpg,.jpeg,.png,.gif,.bmp,.webp,image/*">
      </div>
      <div id="jdFileName" class="mt-3 text-sm font-medium flex justify-between items-center"></div>
     </div><!-- Resume Upload -->
     <div class="p-6 rounded-xl shadow-lg">
      <h2 id="resumeUploadLabel" class="text-2xl font-semibold mb-4">Upload Resumes</h2>
      <div id="resumeDropZone" class="upload-zone rounded-lg p-8 text-center cursor-pointer">
       <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg>
       <p class="text-lg mb-2">Drop resume files here or click to browse</p>
       <p class="text-sm">Supports .txt, .pdf, .docx (Multiple files)</p><input type="file" id="resumeInput" class="hidden" accept=".txt,.pdf,.docx" multiple>
      </div>
      <div id="resumeFileNames" class="mt-3 text-sm font-medium"></div>
      <div id="resumeFilesList" class="mt-3 space-y-2"></div>
     </div>
    </div><!-- Scan Button -->
    <div class="text-center mb-8"><button id="scanBtn" class="px-8 py-4 rounded-lg font-semibold text-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled> <span id="scanBtnText">Scan Resumes</span> </button>
     <div id="scanProgress" class="hidden scanning-progress max-w-2xl mx-auto">
      <div class="flex items-center justify-center mb-3">
       <div class="spinner"></div><span id="progressText" class="font-medium">Scanning resumes... Please wait</span>
      </div>
      <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
       <div id="progressBar" class="progress-bar h-full bg-blue-600" style="width: 0%"></div>
      </div>
      <p class="text-sm mt-2 text-center">‚ö†Ô∏è Do not refresh or close this window</p>
     </div>
    </div>
   </main><!-- Results Modal -->
   <div id="resultsModal" class="hidden">
    <div class="modal-backdrop" id="resultsBackdrop"></div>
    <div class="results-modal rounded-xl shadow-2xl p-8">
     <div class="flex justify-between items-start mb-6">
      <h2 id="modalTitle" class="text-3xl font-bold">Scan Results</h2><button id="closeResultsBtn" class="p-2 rounded-lg hover:bg-gray-200 transition-colors">
       <svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
     <div id="modalContent"></div>
     <div class="flex gap-3 justify-center mt-6"><button id="exportBtnModal" class="px-6 py-3 rounded-lg font-semibold shadow-lg transition-all"> <span id="exportBtnText">üì• Download CSV</span> </button>
     </div>
    </div>
   </div><!-- Tour Overlay -->
   <div id="tourOverlay" class="hidden">
    <div class="tour-overlay"></div>
    <div id="tourSpotlight" class="tour-spotlight"></div>
    <div id="tourTooltip" class="tour-tooltip"></div>
   </div><!-- Error Banner -->
   <div id="errorBanner" class="error-banner hidden">
    <div class="max-w-7xl mx-auto">
     <div class="flex justify-between items-start">
      <div>
       <h4 class="font-bold text-lg mb-2">‚ùå Scanning Errors Detected</h4>
       <div id="errorContent"></div>
      </div><button id="closeErrorBtn" class="text-white hover:text-gray-200 transition-colors">
       <svg class="h-6 w-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
       </svg></button>
     </div>
    </div>
   </div>
  </div>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const defaultConfig = {
      background_color: "#f0f4f8",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#64748b",
      font_family: "system-ui",
      font_size: 16,
      app_title: "Resume Scanner",
      subtitle: "AI-Powered Resume Matching",
      jd_upload_label: "Upload Job Description",
      resume_upload_label: "Upload Resumes",
      scan_button_text: "Scan Resumes",
      candidate_mode_label: "Candidate Mode",
      results_title: "Scan Results",
      export_button_text: "Download CSV",
      tour_welcome_title: "Welcome to Resume Scanner!",
      tour_welcome_message: "Let's take a quick tour of the features"
    };

    const darkModeConfig = {
      background_color: "#0f172a",
      surface_color: "#1e293b",
      text_color: "#f1f5f9",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#94a3b8"
    };

    let isDarkMode = false;
    let currentThemeConfig = { ...defaultConfig };

    let currentData = [];
    let jdFile = null;
    let resumeFiles = [];
    let jdText = '';
    let isCandidateMode = false;
    let scanErrors = [];

    function detectTheme() {
      const savedTheme = localStorage.getItem('resume_scanner_theme');
      if (savedTheme) {
        isDarkMode = savedTheme === 'dark';
      } else {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        isDarkMode = prefersDark;
      }
      applyTheme();
    }

    function applyTheme() {
      const baseTheme = isDarkMode ? { ...defaultConfig, ...darkModeConfig } : { ...defaultConfig };
      
      if (window.elementSdk && window.elementSdk.config) {
        const hasCustomColors = window.elementSdk.config.background_color !== undefined;
        
        if (hasCustomColors) {
          currentThemeConfig = { ...baseTheme, ...window.elementSdk.config };
        } else {
          currentThemeConfig = baseTheme;
        }
      } else {
        currentThemeConfig = baseTheme;
      }
      
      onConfigChange(currentThemeConfig);
      updateModeIcon();
    }

    function toggleTheme() {
      isDarkMode = !isDarkMode;
      localStorage.setItem('resume_scanner_theme', isDarkMode ? 'dark' : 'light');
      applyTheme();
    }

    function applyModeStyles() {
        const scanBtn = document.getElementById('scanBtn');
        const subtitle = document.getElementById('subtitle');
        const label = document.getElementById('candidateModeLabel');

        if (isCandidateMode) {
            // üßë‚Äçüíº Candidate Mode
            scanBtn.style.background = '#22c55e'; // green
            subtitle.textContent = 'Personal Resume Feedback';
            label.textContent = 'Candidate Mode';
        } else {
            // üßë‚Äçüíº Recruiter Mode
            scanBtn.style.background = currentThemeConfig.primary_action_color;
            subtitle.textContent = 'AI-Powered Resume Matching';
            label.textContent = 'Recruiter Mode';
        }
    }

    function updateModeIcon() {
      const icon = document.getElementById('modeIcon');
      if (isDarkMode) {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
      } else {
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
      }
    }

    const dataHandler = {
      onDataChanged(data) {
        currentData = data;
      }
    };

    let sdkInitialized = false;
    // ===== Local Data SDK Adapter (GitHub Pages compatible) =====
    (function () {
    if (window.dataSdk) return; // do not override real SDK

    const STORAGE_KEY = 'resume_scanner_results';

    function load() {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    }

    function save(data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    window.dataSdk = {
        async init(handler) {
        const data = load();
        if (handler && typeof handler.onDataChanged === 'function') {
            handler.onDataChanged(data);
        }
        return { isOk: true };
        },

        async create(record) {
        const data = load();
        data.push(record);
        save(data);
        return { isOk: true };
        }
    };
    })();

    async function initApp() {
      let retries = 0;
      const maxRetries = 100;
      
      while (!window.dataSdk && retries < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }
      
      if (!window.dataSdk) {
        console.error('Data SDK failed to load after 10 seconds');
        sdkInitialized = false;
        return;
      }
      
      try {
        const initResult = await window.dataSdk.init(dataHandler);
        if (!initResult.isOk) {
          console.error('Failed to initialize Data SDK');
          sdkInitialized = false;
        } else {
          sdkInitialized = true;
          checkScanReady();
        }
      } catch (error) {
        console.error('Error initializing app:', error);
        sdkInitialized = false;
      }
    }

    async function onConfigChange(config) {
      const customFont = config.font_family || currentThemeConfig.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || currentThemeConfig.font_size || defaultConfig.font_size;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const fontFamily = `${customFont}, ${baseFontStack}`;

      const bgColor = config.background_color || currentThemeConfig.background_color;
      const surfaceColor = config.surface_color || currentThemeConfig.surface_color;
      const textColor = config.text_color || currentThemeConfig.text_color;
      const primaryColor = config.primary_action_color || currentThemeConfig.primary_action_color;
      const secondaryColor = config.secondary_action_color || currentThemeConfig.secondary_action_color;

      document.getElementById('app').style.background = bgColor;
      document.getElementById('app').style.color = textColor;
      document.getElementById('app').style.fontFamily = fontFamily;
      document.getElementById('app').style.fontSize = `${baseSize}px`;

      document.getElementById('appTitle').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('appTitle').style.fontSize = `${baseSize * 2}px`;
      document.getElementById('appTitle').style.color = textColor;

      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
      document.getElementById('subtitle').style.fontSize = `${baseSize * 1.25}px`;
      document.getElementById('subtitle').style.color = secondaryColor;

      document.getElementById('jdUploadLabel').textContent = config.jd_upload_label || defaultConfig.jd_upload_label;
      document.getElementById('jdUploadLabel').style.fontSize = `${baseSize * 1.5}px`;
      document.getElementById('jdUploadLabel').style.color = textColor;

      document.getElementById('resumeUploadLabel').textContent = config.resume_upload_label || defaultConfig.resume_upload_label;
      document.getElementById('resumeUploadLabel').style.fontSize = `${baseSize * 1.5}px`;
      document.getElementById('resumeUploadLabel').style.color = textColor;

      document.getElementById('scanBtnText').textContent = config.scan_button_text || defaultConfig.scan_button_text;
      document.getElementById('exportBtnText').textContent = config.export_button_text || defaultConfig.export_button_text;

      document.getElementById('candidateModeLabel').textContent = config.candidate_mode_label || defaultConfig.candidate_mode_label;
      document.getElementById('candidateModeLabel').style.color = textColor;

      document.querySelectorAll('.upload-zone').forEach(zone => {
        zone.parentElement.style.background = surfaceColor;
        zone.style.color = textColor;
      });

      document.getElementById('scanBtn').style.background = primaryColor;
      document.getElementById('scanBtn').style.color = surfaceColor;
      document.getElementById('scanBtn').style.fontSize = `${baseSize * 1.125}px`;

      document.getElementById('exportBtnModal').style.background = secondaryColor;
      document.getElementById('exportBtnModal').style.color = surfaceColor;

      const modalContent = document.querySelector('.modal-backdrop + div');
      if (modalContent) {
        modalContent.style.background = surfaceColor;
        modalContent.style.color = textColor;
      }

      const resultsModalContent = document.querySelector('.results-modal');
      if (resultsModalContent) {
        resultsModalContent.style.background = surfaceColor;
        resultsModalContent.style.color = textColor;
      }


      document.getElementById('modeToggle').style.background = surfaceColor;
      document.getElementById('modeToggle').style.color = textColor;

      document.getElementById('tourBtn').style.background = primaryColor;
      document.getElementById('tourBtn').style.color = surfaceColor;

      document.getElementById('progressText').style.color = textColor;
      document.getElementById('scanProgress').style.color = textColor;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            { get: () => config.background_color || defaultConfig.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
            { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
            { get: () => config.text_color || defaultConfig.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
            { get: () => config.primary_action_color || defaultConfig.primary_action_color, set: (v) => { config.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); } },
            { get: () => config.secondary_action_color || defaultConfig.secondary_action_color, set: (v) => { config.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); } }
          ],
          borderables: [],
          fontEditable: { get: () => config.font_family || defaultConfig.font_family, set: (v) => { config.font_family = v; window.elementSdk.setConfig({ font_family: v }); } },
          fontSizeable: { get: () => config.font_size || defaultConfig.font_size, set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); } }
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["subtitle", config.subtitle || defaultConfig.subtitle],
          ["jd_upload_label", config.jd_upload_label || defaultConfig.jd_upload_label],
          ["resume_upload_label", config.resume_upload_label || defaultConfig.resume_upload_label],
          ["scan_button_text", config.scan_button_text || defaultConfig.scan_button_text],
          ["candidate_mode_label", config.candidate_mode_label || defaultConfig.candidate_mode_label],
          ["results_title", config.results_title || defaultConfig.results_title],
          ["export_button_text", config.export_button_text || defaultConfig.export_button_text],
          ["tour_welcome_title", config.tour_welcome_title || defaultConfig.tour_welcome_title],
          ["tour_welcome_message", config.tour_welcome_message || defaultConfig.tour_welcome_message]
        ])
      });
    }

    async function readFile(file) {
      const fileType = file.name.split('.').pop().toLowerCase();
      
      if (fileType === 'txt') {
        return await readTextFile(file);
      } else if (fileType === 'pdf') {
        return await readPdfFile(file);
      } else if (fileType === 'docx') {
        return await readDocxFile(file);
      } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileType)) {
        return await readImageFile(file);
      }
      return '';
    }

    async function readTextFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsText(file);
      });
    }

    async function readPdfFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const typedArray = new Uint8Array(e.target.result);
          const pdf = await pdfjsLib.getDocument(typedArray).promise;
          let text = '';
          
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str).join(' ') + '\n';
          }
          resolve(text);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    async function readDocxFile(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const arrayBuffer = e.target.result;
          const result = await mammoth.extractRawText({ arrayBuffer });
          resolve(result.value);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    async function readImageFile(file) {
      try {
        const result = await Tesseract.recognize(file, 'eng', {
          logger: m => {
            if (m.status === 'recognizing text') {
              console.log(`OCR Progress: ${Math.round(m.progress * 100)}%`);
            }
          }
        });
        return result.data.text;
      } catch (error) {
        throw new Error('Failed to extract text from image');
      }
    }

    function extractSkills(text) {
      const commonSkills = [
        'javascript', 'python', 'java', 'react', 'angular', 'vue', 'node', 'express',
        'sql', 'mongodb', 'postgresql', 'aws', 'azure', 'docker', 'kubernetes',
        'html', 'css', 'typescript', 'git', 'agile', 'scrum', 'rest api', 'graphql',
        'machine learning', 'ai', 'data analysis', 'excel', 'powerpoint', 'communication',
        'leadership', 'project management', 'teamwork', 'problem solving', 'spring boot',
        'django', 'flask', 'redis', 'jenkins', 'ci/cd', 'devops', 'linux', 'windows'
      ];
      
      const lowerText = text.toLowerCase();
      const foundSkills = commonSkills.filter(skill => 
        lowerText.includes(skill)
      );
      
      return foundSkills;
    }

    function calculateMatch(resumeText, jdSkills) {
      const lowerResume = resumeText.toLowerCase();
      const matchedSkills = jdSkills.filter(skill => lowerResume.includes(skill));
      const missingSkills = jdSkills.filter(skill => !lowerResume.includes(skill));
      const score = jdSkills.length > 0 ? Math.round((matchedSkills.length / jdSkills.length) * 100) : 0;
      
      return { score, matchedSkills, missingSkills };
    }

    async function scanResumes() {
      // üõë VALIDATIONS
      // Make sure JD and resumes are uploaded
      if (!jdText || resumeFiles.length === 0) {
        showToast('Please upload both JD and resumes', 'error');
        return;
      }

      // üö´ Candidate Mode: allow only ONE resume per scan
      if (isCandidateMode && resumeFiles.length > 1) {
        showToast('Candidate Mode allows only one resume per scan.', 'error');
        return;
      }

      // Ensure SDK is initialized
      if (!sdkInitialized || !window.dataSdk) {
        showToast('App is still initializing. Please wait a moment and try again.', 'error');
        return;
      }

      // üî• CLEAR OLD SCAN DATA (start fresh scan)
      currentData = [];
      localStorage.removeItem('resume_scanner_results');

      // Limit total scans to 999
      if (currentData.length + resumeFiles.length > 999) {
        showToast('Maximum limit of 999 scans reached. Please delete some results first.', 'error');
        return;
      }
      // üöÄ START SCANNING
      scanErrors = [];
      const scanBtn = document.getElementById('scanBtn');
      const btnText = document.getElementById('scanBtnText');
      const progressDiv = document.getElementById('scanProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      scanBtn.disabled = true;
      progressDiv.classList.remove('hidden');
      btnText.textContent = 'Scanning...';

      showInlineWarning('‚ö†Ô∏è Do not refresh or close this window during scanning!');

      const jdSkills = extractSkills(jdText);
      const totalFiles = resumeFiles.length;
      let processedFiles = 0;
      
      for (const file of resumeFiles) {
        try {
          progressText.textContent = `Scanning ${file.name}... (${processedFiles + 1}/${totalFiles})`;
          
          const resumeText = await readFile(file);
          const { score, matchedSkills, missingSkills } = calculateMatch(resumeText, jdSkills);
          
          const result = await window.dataSdk.create({
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            job_title: jdFile.name.replace(/\.[^/.]+$/, ""),
            candidate_name: file.name.replace(/\.[^/.]+$/, ""),
            resume_filename: file.name,
            match_score: score,
            matched_skills: matchedSkills.join(', '),
            missing_skills: missingSkills.join(', '),
            total_skills: jdSkills.length,
            scan_date: new Date().toISOString(),
            errors: ""
          });

          // ‚úÖ ADD RESULT TO IN-MEMORY DATA FOR UI / EXPORT / EMAIL
        currentData.push({
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            job_title: jdFile.name.replace(/\.[^/.]+$/, ""),
            candidate_name: file.name.replace(/\.[^/.]+$/, ""),
            resume_filename: file.name,
            match_score: score,
            matched_skills: matchedSkills.join(', '),
            missing_skills: missingSkills.join(', '),
            total_skills: jdSkills.length,
            scan_date: new Date().toISOString(),
            errors: ""
        });


          if (!result.isOk) {
            scanErrors.push({
              file: file.name,
              error: 'Failed to save scan result to database'
            });
          }
        } catch (error) {
          scanErrors.push({
            file: file.name,
            error: error.message || 'Unknown error during scanning'
          });
        }
        
        processedFiles++;
        const progress = (processedFiles / totalFiles) * 100;
        progressBar.style.width = `${progress}%`;
      }

      scanBtn.disabled = false;
      btnText.textContent = window.elementSdk ? window.elementSdk.config.scan_button_text || defaultConfig.scan_button_text : defaultConfig.scan_button_text;
      progressDiv.classList.add('hidden');
      progressBar.style.width = '0%';
      
      hideInlineWarning();

      if (scanErrors.length > 0) {
        showErrorBanner();
      }

      showToast('Scan completed!', 'success');
      showResultsModal();
    }

    function showResultsModal() {
      const modal = document.getElementById('resultsModal');
      const content = document.getElementById('modalContent');
      
      if (isCandidateMode) {
        renderCandidateSuggestions(content);
      } else {
        renderAllResults(content);
      }
      
      modal.classList.remove('hidden');
    }

    function renderCandidateSuggestions(container) {
      if (currentData.length === 0) return;

      const latestScan = currentData[currentData.length - 1];
      const config = window.elementSdk ? window.elementSdk.config : currentThemeConfig;
      const surfaceColor = config.surface_color || currentThemeConfig.surface_color;
      const textColor = config.text_color || currentThemeConfig.text_color;
      const primaryColor = config.primary_action_color || currentThemeConfig.primary_action_color;
      const secondaryColor = config.secondary_action_color || currentThemeConfig.secondary_action_color;
      const scoreColor = latestScan.match_score >= 70 ? '#22c55e' : latestScan.match_score >= 40 ? '#f59e0b' : '#ef4444';

      const missingSkills = latestScan.missing_skills ? latestScan.missing_skills.split(', ').filter(s => s) : [];
      const matchedSkills = latestScan.matched_skills ? latestScan.matched_skills.split(', ').filter(s => s) : [];

      container.innerHTML = `
        <div class="p-6 rounded-xl shadow-lg mb-6" style="background: ${surfaceColor};">
          <div class="flex justify-between items-center mb-4">
            <div>
              <h3 class="text-2xl font-bold" style="color: ${textColor};">Your Match Score</h3>
              <p class="text-sm" style="color: ${secondaryColor};">Based on: ${latestScan.job_title}</p>
            </div>
            <div class="text-5xl font-bold" style="color: ${scoreColor};">${latestScan.match_score}%</div>
          </div>
          <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
            <div class="progress-bar h-full rounded-full" style="width: ${latestScan.match_score}%; background: ${scoreColor};"></div>
          </div>
        </div>

        <div class="space-y-4">
          <div class="suggestion-card p-6 rounded-xl shadow-lg" style="background: ${surfaceColor};">
            <h4 class="text-xl font-bold mb-3" style="color: ${textColor};">‚úÖ Skills You Have (${matchedSkills.length})</h4>
            <div class="flex flex-wrap gap-2">
              ${matchedSkills.map(skill => `
                <span class="px-3 py-1 rounded-full text-sm font-medium" style="background: ${primaryColor}20; color: ${primaryColor};">
                  ${skill}
                </span>
              `).join('')}
            </div>
          </div>

          ${missingSkills.length > 0 ? `
            <div class="suggestion-card p-6 rounded-xl shadow-lg" style="background: ${surfaceColor}; border-left-color: ${scoreColor};">
              <h4 class="text-xl font-bold mb-3" style="color: ${textColor};">üéØ Skills to Add (${missingSkills.length})</h4>
              <div class="flex flex-wrap gap-2 mb-4">
                ${missingSkills.map(skill => `
                  <span class="px-3 py-1 rounded-full text-sm font-medium" style="background: ${scoreColor}20; color: ${scoreColor};">
                    ${skill}
                  </span>
                `).join('')}
              </div>
              <div class="mt-4 p-4 rounded-lg" style="background: ${primaryColor}10;">
                <p class="font-medium mb-2" style="color: ${textColor};">üí° Recommendations:</p>
                <ul class="space-y-2 text-sm" style="color: ${secondaryColor};">
                  <li>‚Ä¢ Add these skills to your resume if you have experience with them</li>
                  <li>‚Ä¢ Consider taking online courses to learn these in-demand skills</li>
                  <li>‚Ä¢ Update your projects section to highlight relevant experience</li>
                  <li>‚Ä¢ Use exact keywords from the job description</li>
                </ul>
              </div>
            </div>
          ` : `
            <div class="p-6 rounded-xl shadow-lg text-center" style="background: ${surfaceColor};">
              <div class="text-5xl mb-3">üéâ</div>
              <h4 class="text-2xl font-bold mb-2" style="color: ${textColor};">Perfect Match!</h4>
              <p style="color: ${secondaryColor};">Your resume contains all the required skills for this position.</p>
            </div>
          `}
        </div>
      `;
    }

    function renderAllResults(container) {
      const sortedData = [...currentData].sort((a, b) => b.match_score - a.match_score);
      const config = window.elementSdk ? window.elementSdk.config : currentThemeConfig;
      const surfaceColor = config.surface_color || currentThemeConfig.surface_color;
      const textColor = config.text_color || currentThemeConfig.text_color;
      const secondaryColor = config.secondary_action_color || currentThemeConfig.secondary_action_color;

      container.innerHTML = `
        <div class="space-y-4 max-h-96 overflow-y-auto">
          ${sortedData.map(result => {
            const scoreColor = result.match_score >= 70 ? '#22c55e' : result.match_score >= 40 ? '#f59e0b' : '#ef4444';
            
            return `
              <div class="p-6 rounded-xl shadow-lg" style="background: ${surfaceColor};">
                <div class="flex justify-between items-start mb-4">
                  <div class="flex-1">
                    <h3 class="text-xl font-bold" style="color: ${textColor};">${result.candidate_name}</h3>
                    <p class="text-sm" style="color: ${secondaryColor};">Job: ${result.job_title}</p>
                    <p class="text-xs" style="color: ${secondaryColor};">${new Date(result.scan_date).toLocaleDateString()}</p>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold" style="color: ${scoreColor};">${result.match_score}%</div>
                    <div class="text-sm" style="color: ${secondaryColor};">Match Score</div>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div class="progress-bar h-full rounded-full" style="width: ${result.match_score}%; background: ${scoreColor};"></div>
                  </div>
                </div>
                <div>
                  <p class="text-sm font-medium mb-1" style="color: ${textColor};">Matched Skills:</p>
                  <p class="text-sm" style="color: ${secondaryColor};">${result.matched_skills || 'None'}</p>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function exportToCSV() {
      if (currentData.length === 0) {
        showToast('No results to export', 'error');
        return;
      }

      const headers = ['Candidate Name', 'Job Title', 'Match Score (%)', 'Matched Skills', 'Missing Skills', 'Total Skills', 'Scan Date'];
      const rows = currentData.map(r => [
        r.candidate_name,
        r.job_title,
        r.match_score,
        r.matched_skills,
        r.missing_skills,
        r.total_skills,
        new Date(r.scan_date).toLocaleDateString()
      ]);

      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += row.map(cell => `"${cell}"`).join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `resume_scan_results_${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('CSV downloaded successfully!', 'success');
    }

    function showErrorBanner() {
      const banner = document.getElementById('errorBanner');
      const content = document.getElementById('errorContent');
      
      content.innerHTML = `
        <p class="mb-2">The following errors occurred during scanning:</p>
        <ul class="list-disc list-inside space-y-1">
          ${scanErrors.map(err => `
            <li><strong>${err.file}:</strong> ${err.error}</li>
          `).join('')}
        </ul>
        <p class="mt-3 text-sm">üí° Suggestions:</p>
        <ul class="list-disc list-inside text-sm mt-1">
          <li>Ensure files are not corrupted or password-protected</li>
          <li>Try converting PDF files to a different format</li>
          <li>For images, ensure text is clear and readable</li>
          <li>Check that files are properly formatted documents</li>
        </ul>
      `;
      
      banner.classList.remove('hidden');
    }

    function showToast(message, type = 'info') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) existingToast.remove();

      const colors = {
        success: '#22c55e',
        error: '#ef4444',
        info: '#3b82f6'
      };

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.style.borderLeft = `4px solid ${colors[type]}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 4000);
    }

    function showInlineWarning(message) {
      const existingWarning = document.getElementById('inlineWarning');
      if (existingWarning) existingWarning.remove();

      const warning = document.createElement('div');
      warning.id = 'inlineWarning';
      warning.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 font-semibold';
      warning.textContent = message;
      document.body.appendChild(warning);
    }

    function hideInlineWarning() {
      const warning = document.getElementById('inlineWarning');
      if (warning) warning.remove();
    }

    function setupDragDrop(dropZoneId, inputId, isMultiple = false) {
      const dropZone = document.getElementById(dropZoneId);
      const input = document.getElementById(inputId);

      dropZone.addEventListener('click', () => input.click());

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        const files = Array.from(e.dataTransfer.files);
        if (isMultiple) {
          handleResumeUpload(files);
        } else {
          handleJDUpload(files[0]);
        }
      });

      input.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (isMultiple) {
          handleResumeUpload(files);
        } else {
          handleJDUpload(files[0]);
        }
      });
    }

    async function handleJDUpload(file) {
      if (!file) return;
      
      const fileType = file.name.split('.').pop().toLowerCase();
      const isImage = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(fileType);
      
      if (isImage) {
        showToast('Extracting text from image... This may take a moment', 'info');
      } else {
        showToast('Processing job description...', 'info');
      }
      
      jdFile = file;
      
      try {
        jdText = await readFile(file);
        
        const config = window.elementSdk ? window.elementSdk.config : currentThemeConfig;
        const primaryColor = config.primary_action_color || currentThemeConfig.primary_action_color;
        
        document.getElementById('jdFileName').innerHTML = `
          <span>üìÑ ${file.name}</span>
          <button onclick="deleteJD()" class="delete-btn px-3 py-1 rounded text-sm" style="background: #ef4444; color: white;">Remove</button>
        `;
        checkScanReady();
        showToast('Job description uploaded successfully', 'success');
      } catch (error) {
        showToast('Failed to read job description: ' + error.message, 'error');
        jdFile = null;
        jdText = '';
        checkScanReady();
      }
    }

    function deleteJD() {
      jdFile = null;
      jdText = '';
      document.getElementById('jdFileName').innerHTML = '';
      document.getElementById('jdInput').value = '';
      checkScanReady();
      showToast('Job description removed', 'info');
    }

    window.deleteJD = deleteJD;

    function handleResumeUpload(files) {
      if (!files || files.length === 0) return;
      
      resumeFiles = Array.from(files);
      renderResumeList();
      checkScanReady();
      showToast(`${files.length} resume(s) uploaded successfully`, 'success');
    }

    function renderResumeList() {
      const config = window.elementSdk ? window.elementSdk.config : currentThemeConfig;
      const textColor = config.text_color || currentThemeConfig.text_color;
      const surfaceColor = config.surface_color || currentThemeConfig.surface_color;
      
      const container = document.getElementById('resumeFilesList');
      container.innerHTML = resumeFiles.map((file, index) => `
        <div class="flex justify-between items-center p-3 rounded-lg" style="background: ${surfaceColor};">
          <span class="text-sm" style="color: ${textColor};">üìÑ ${file.name}</span>
          <button onclick="deleteResume(${index})" class="delete-btn px-3 py-1 rounded text-sm" style="background: #ef4444; color: white;">Remove</button>
        </div>
      `).join('');

      document.getElementById('resumeFileNames').textContent = `${resumeFiles.length} file(s) selected`;
    }

    function deleteResume(index) {
      resumeFiles.splice(index, 1);
      renderResumeList();
      checkScanReady();
      showToast('Resume removed', 'info');
      
      if (resumeFiles.length === 0) {
        document.getElementById('resumeInput').value = '';
        document.getElementById('resumeFileNames').textContent = '';
      }
    }

    window.deleteResume = deleteResume;

    function checkScanReady() {
      const scanBtn = document.getElementById('scanBtn');
      scanBtn.disabled = !(jdFile && jdText && resumeFiles.length > 0);
    }

    const tourSteps = [
      {
        element: 'modeToggle',
        title: 'Dark/Light Mode',
        description: 'Toggle between dark and light themes. Your preference will be saved for future visits!'
      },
      {
        element: 'candidateMode',
        title: 'Candidate Mode',
        description: 'Switch to Candidate Mode to get personalized feedback and suggestions on your resume!'
      },
      {
        element: 'jdDropZone',
        title: 'Upload Job Description',
        description: 'Upload the job description in .txt, .pdf, .docx, or even image formats. We\'ll extract the text!'
      },
      {
        element: 'resumeDropZone',
        title: 'Upload Resumes',
        description: 'Upload one or multiple resumes to scan against the job description. Drag & drop supported!'
      },
      {
        element: 'scanBtn',
        title: 'Scan Resumes',
        description: 'Click here to start the scanning process. Results are saved automatically!'
      }
    ];

    let currentTourStep = 0;

    function startTour() {
      if (!localStorage.getItem('resume_scanner_tour_completed')) {
        showTourStep(0);
      }
    }

    function showTourStep(stepIndex) {
      if (stepIndex >= tourSteps.length) {
        endTour();
        return;
      }

      currentTourStep = stepIndex;
      const step = tourSteps[stepIndex];
      const element = document.getElementById(step.element);
      
      if (!element) {
        showTourStep(stepIndex + 1);
        return;
      }

      const rect = element.getBoundingClientRect();
      const config = window.elementSdk ? window.elementSdk.config : currentThemeConfig;
      const surfaceColor = config.surface_color || currentThemeConfig.surface_color;
      const textColor = config.text_color || currentThemeConfig.text_color;
      const primaryColor = config.primary_action_color || currentThemeConfig.primary_action_color;
      
      document.getElementById('tourOverlay').classList.remove('hidden');
      
      const spotlight = document.getElementById('tourSpotlight');
      spotlight.style.left = `${rect.left - 8}px`;
      spotlight.style.top = `${rect.top - 8}px`;
      spotlight.style.width = `${rect.width + 16}px`;
      spotlight.style.height = `${rect.height + 16}px`;

      const tooltip = document.getElementById('tourTooltip');
      tooltip.style.background = surfaceColor;
      tooltip.innerHTML = `
        <h3 class="text-xl font-bold mb-2" style="color: ${textColor};">${step.title}</h3>
        <p class="mb-4" style="color: ${textColor};">${step.description}</p>
        <div class="flex justify-between items-center">
          <span class="text-sm" style="color: ${textColor};">Step ${stepIndex + 1} of ${tourSteps.length}</span>
          <div class="flex gap-2">
            <button onclick="skipTour()" class="px-4 py-2 rounded font-medium" style="background: #64748b; color: white;">Skip</button>
            <button onclick="nextTourStep()" class="px-4 py-2 rounded font-medium" style="background: ${primaryColor}; color: white;">
              ${stepIndex === tourSteps.length - 1 ? 'Finish' : 'Next'}
            </button>
          </div>
        </div>
      `;

      const tooltipTop = rect.bottom + 20;
      const tooltipLeft = Math.max(20, Math.min(window.innerWidth - 420, rect.left));
      tooltip.style.top = `${tooltipTop}px`;
      tooltip.style.left = `${tooltipLeft}px`;
    }

    function nextTourStep() {
      showTourStep(currentTourStep + 1);
    }

    function skipTour() {
      endTour();
    }

    function endTour() {
      document.getElementById('tourOverlay').classList.add('hidden');
      localStorage.setItem('resume_scanner_tour_completed', 'true');
      showToast('Tour completed! Enjoy using Resume Scanner!', 'success');
    }

    window.nextTourStep = nextTourStep;
    window.skipTour = skipTour;

    setupDragDrop('jdDropZone', 'jdInput', false);
    setupDragDrop('resumeDropZone', 'resumeInput', true);

    document.getElementById('scanBtn').addEventListener('click', scanResumes);
    document.getElementById('exportBtnModal').addEventListener('click', exportToCSV);
    document.getElementById('modeToggle').addEventListener('click', toggleTheme);
    document.getElementById('tourBtn').addEventListener('click', () => showTourStep(0));
    document.getElementById('closeResultsBtn').addEventListener('click', () => {
      document.getElementById('resultsModal').classList.add('hidden');
    });
    document.getElementById('resultsBackdrop').addEventListener('click', () => {
      document.getElementById('resultsModal').classList.add('hidden');
    });
    document.getElementById('closeErrorBtn').addEventListener('click', () => {
      document.getElementById('errorBanner').classList.add('hidden');
    });
    
    document.getElementById('candidateMode').addEventListener('change', (e) => {
      isCandidateMode = e.target.checked;
      applyModeStyles();
    });

    detectTheme();
    initApp();
    applyModeStyles();
    
    setTimeout(() => {
      if (!localStorage.getItem('resume_scanner_tour_completed')) {
        startTour();
      }
    }, 1000);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b4fcd08305b84d1',t:'MTc2NjkxMTczMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>